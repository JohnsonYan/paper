%# -*- coding: utf-8-unix -*-

\chapter{对比实验和结果分析}

\section{实验数据集的选择}

上一章的最后一节已经介绍了KDD Cup 99数据集，并且说明了对数据的预处理步骤，在最后介绍了本文将使用KDD Cup 99数据集中的“KDD 10\%”和“corrected”这两个数据集作为训练和测试数据集。这一节将详细说明一下这两个数据集在实验中各自的用途。

首先，我选择了完整训练数据集的10\%的数据集作为我的训练数据集，考虑了如下两个原因：一是将完整的训练数据集用于训练使得我的训练时间延长了10倍以上(鉴于使用的个人电脑计算能力有限)，二是在基于深度学习的网络流量异常检测算法的实现过程中，我在其他参数相同的情况下对比了使用完整训练数据集以及使用完整训练数据集的10\%作为训练数据集的情况下，模型的准确率相当，经完整训练数据集训练后的模型仅仅比使用10\%数据进行训练后的模型的准确率提高了0.001\%，而训练时间却增加了10倍不止。所以，我选择了数据量较为小的数据集作为训练数据集。

关于测试集的选择，阅读了一些文献发现，有一些文献中的测试集选择的同样是训练数据集，只是将训练数据集分割了，其中70\%-75\%的数据用于训练，25\%-30\%的数据用于测试。这种选择虽然在一些其它数据集上很常见，因为其它数据集只有唯一一个训练数据集，但是对于KDD Cup 99数据集来说，我认为应该将corrected数据集作为测试数据集。首先，corrected数据集本身就是设计者专门收集用于测试的，其次，使用包含未知攻击类型的数据集进行测试可以更好的测试我们所构建的模型的泛化能力。从已知攻击类型学习到检测未知攻击类型的异常流量这一能力正是网络流量异常检测算法研究所迫切需要的。当然，也不能否认训练、测试都在训练数据集中的这种方法所体现的机器学习的强大抽象、学习、分类能力。

因此，在实验中我选择使用KDD 10\%的数据对模型进行训练，corrected测试数据集对模型进行测试。同时，我也给出了使用从训练数据集分割出来部分数据进行测试的准确率。

\section{实验平台}

本章实验是在macOS High Sierra 10.13.4操作系统上进行的，开发语言使用了Python3，Python版本号是3.6.4。硬件平台CPU型号是Intel Core i5-5257U，双核心四线程，CPU主频是2.7GHz，最大可以睿频到3.1GHz，内存为8GB的DDR3内存，内存频率为1867MHz。

\section{实验过程和结果分析}

在对训练数据集和测试数据集预处理后，得到了$494021 \times 122$和$311029 \times 122$维的输入数据。这两组数据将用于对模型的训练和测试。在训练数据中，将随机抽取其中的25\%出来作为验证集。验证集在训练中不会被训练到，仅仅用于调超参数。

本实验进行了多组控制变量的对比实验，在前一个实验当中表现最好的结构将用于下一组实验中，最终通过多组的对比试验构建出表现较为优秀的模型用于网络异常流量检测。

\subsection{模型深度与节点数目的选择}

在本节实验中，本文进行了多次实验，每次实验构建的深度学习网络结构的层数或节点数都是不相同的，通过多次实验的比对，得到了不同层数对应的准确率汇。除了网络参数不同外，其他参数相同，其他参数分别为：
\begin{itemize}
    \item batchsize: 512
    \item dropout: 0(即不使用dropout)
    \item 激活函数: relu
    \item 优化算法: nadam
    \item 损失函数: categorical\_crossentropy
\end{itemize}

测试结果汇总如下：
% Table generated by Excel2LaTeX from sheet 'Sheet2'
\begin{table}[htbp]
	\centering
	\caption{不同网络参数的实验结果}
	\begin{tabular}{c|c|c|c|c}
		\toprule
		模型序号 & 网络参数             & 准确率  & params  & time      \\
		\midrule
		model1-1   & 24-256-512-256-5     & 92.44\% & 273549  & 22s/epoch \\
		\midrule
		model1-2   & 12-128-256-128-5     & 92.10\% & 69705   & 10s/epoch \\
		\midrule
		model1-3   & 48-512-1024-512-5    & 73.90\% & 1083669 & 72s/epoch \\
		\midrule
		model1-4   & 12-24-48-24-5        & 91.99\% & 4289    & 6s/epoch  \\
		\midrule
		model1-5   & 6-12-24-12-5         & 91.44\% & 1499    & 5s/epoch  \\
		\midrule
		model1-6   & 3-6-12-6-5           & 90.86\% & 590     & 5s/epoch  \\
		\midrule
		model1-7   & 24-512-256-5         & 92.32\% & 148365  & 15s/epoch \\
		\midrule
		model1-8   & 24-256-512-256-128-5 & 92.07\% & 305805  & 24s/epoch \\
		\midrule
		model1-9   & 10-50-10-5           & 91.96\% & 2345    & 5s/epoch  \\
		\bottomrule
	\end{tabular}%
	\label{tab:exp1-1}%
\end{table}%

\begin{figure}[H]
    \centering
    \includegraphics[width=0.99\textwidth]{exp1.pdf}
    \caption{网络参数-准确率结果}
    \label{fig:exp1-2}
\end{figure}

\subsection{batchsize大小的选择}

在上一节的实验中，可以发现，模型model1-1的网络参数取得了最好的测试成绩，同时它的训练时间也比较短，故本节实验在model1-1的网络参数的基础上，测试batchsize大小的选择对模型表现的影响。下面的图表是模型的网络参数为“24-256-512-256-5”的基础上不同batchsize的实验结果：
% Table generated by Excel2LaTeX from sheet 'Sheet2'
\begin{table}[htbp]
	\centering
	\caption{不同batchsize的实验结果}
	\begin{tabular}{cccc}
		模型序号 & batchsize & 准确率  & time       \\
		model2-1  & 512       & 92.12\% & 23s/epoch  \\
		model2-2  & 256       & 92.16\% & 27s/epoch  \\
		model2-3  & 128       & 92.44\% & 37s/epoch  \\
		model2-4  & 64        & 92.24\% & 57s/epoch  \\
		model2-5  & 32        & 92.51\% & 98s/epoch  \\
		model2-6  & 16        & 92.26\% & 185s/epoch \\
		model2-7  & 8         & 92.43\% & 360s/epoch \\
		model2-8  & 1024      & 92.39\% & 20s/epoch  \\
		model2-9  & 2048      & 92.67\% & 19s/epoch  \\
	\end{tabular}%
	\label{tab:exp2-1}%
\end{table}%

\begin{figure}[H]
    \centering
    \includegraphics[width=0.99\textwidth]{exp2.pdf}
    \caption{batchsize-准确率结果}
    \label{fig:exp2-2}
\end{figure}

\subsection{优化算法的选择}

在上一节的实验中，可以发现，模型model2-9的batchsize取得了最好的测试成绩，故本节实验在model2-9的batchsize大小以及model1-1的网络参数的基础上，测试不同的优化算法的选择对模型表现的影响。

\subsection{不同分类精度下模型的表现}

从第三章对KDD Cup 99数据集的介绍中得知，每一条数据都被标记为正常(Normal)或者异常(Attack)，异常类型的数据被细分为4大类共39种攻击类型，其中22种攻击类型出现在了训练数据集中，其它的17种未知攻击类型被收纳在测试数据集中。由于有17种类型的攻击数据只在测试集中出现，而在整个模型的实现以及测试过程中，需要对标记数据提前进行编码，所以即使将39种攻击类型都提前编码，在测试时模型也无法输出超出其本身23种(1种正常标记和22种攻击类型标记)编码范围的结果。所以，本实验将数据的标记进行了整理，分为了两种类型：
\begin{enumerate}
    \item 五分类：NORMAL,PROBE,DOS,U2R,R2L这五类标记代表了所有的39种攻击以及正常流量。模型将对输入的数据给出五种之中的一种。
    \item 二分类：Normal,Attack分别用0，1表示。模型只在(0,1)这两个数字中给出结果。也是网络流量异常检测最基本的功能，即区分正常流量和异常流量。
\end{enumerate}

那么，对于五分类以及二分类这两种不同的分类情况，模型的准确率会有很大的差别吗？下面的实验结果给出了答案。

\subsection{结果分析}

\section{本章小结}